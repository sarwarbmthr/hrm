{% extends 'index.html' %}
{% load i18n %}

{% block content %}
<style>
  * {
    box-sizing: border-box;
  }

  .license-edit-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 20px;
  }

  .license-edit-card {
    background: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 30px;
  }

  .license-edit-header {
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 18px;
    margin-bottom: 28px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .license-edit-header-content h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
    color: #1f2937;
  }

  .license-edit-header-content p {
    margin: 8px 0 0;
    font-size: 14px;
    color: #6b7280;
  }

  .btn-add-company {
    background-color: #10b981;
    color: #ffffff;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-add-company:hover {
    background-color: #059669;
  }

  .companies-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .company-item {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    transition: all 0.2s ease;
  }

  .company-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .company-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .company-name {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
  }

  .company-actions {
    display: flex;
    gap: 8px;
  }

  .btn-edit, .btn-delete {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-edit {
    background-color: #3b82f6;
    color: #ffffff;
  }

  .btn-edit:hover {
    background-color: #2563eb;
  }

  .btn-delete {
    background-color: #ef4444;
    color: #ffffff;
  }

  .btn-delete:hover {
    background-color: #dc2626;
  }

  .company-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .company-detail-item {
    display: flex;
    flex-direction: column;
  }

  .detail-label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
  }

  .detail-value {
    font-size: 14px;
    color: #1f2937;
    font-weight: 500;
  }

  .license-expiry {
    padding: 4px 12px;
    border-radius: 6px;
    display: inline-block;
    font-size: 13px;
    font-weight: 600;
  }

  .license-expiry.expired {
    background-color: #fee2e2;
    color: #dc2626;
  }

  .license-expiry.expiring-soon {
    background-color: #fef3c7;
    color: #d97706;
  }

  .license-expiry.valid {
    background-color: #dcfce7;
    color: #16a34a;
  }

  .license-expiry.no-date {
    background-color: #f3f4f6;
    color: #6b7280;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: #ffffff;
    border-radius: 12px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }

  .modal-header {
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 16px;
    margin-bottom: 24px;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #1f2937;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
  }

  .form-label .required {
    color: #ef4444;
    margin-left: 4px;
  }

  .form-input, .form-textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.2s ease;
  }

  .form-input:focus, .form-textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-textarea {
    resize: vertical;
    min-height: 80px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
  }

  .btn {
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background-color: #2563eb;
    color: #ffffff;
  }

  .btn-primary:hover {
    background-color: #1d4ed8;
  }

  .btn-secondary {
    background-color: #e5e7eb;
    color: #374151;
  }

  .btn-secondary:hover {
    background-color: #d1d5db;
  }

  .alert {
    padding: 14px 18px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .alert-success {
    background-color: #dcfce7;
    color: #15803d;
    border: 1px solid #86efac;
  }

  .alert-error {
    background-color: #fee2e2;
    color: #b91c1c;
    border: 1px solid #fca5a5;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
  }

  .empty-state-icon {
    font-size: 64px;
    color: #d1d5db;
    margin-bottom: 16px;
  }

  .empty-state h3 {
    font-size: 20px;
    color: #6b7280;
    margin: 0 0 8px;
  }

  .empty-state p {
    font-size: 14px;
    color: #9ca3af;
    margin: 0 0 24px;
  }

  @media (max-width: 768px) {
    .license-edit-container {
      padding: 10px;
      margin: 20px auto;
    }

    .license-edit-card {
      padding: 20px;
    }

    .license-edit-header {
      flex-direction: column;
      align-items: stretch;
    }

    .btn-add-company {
      justify-content: center;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .company-item-header {
      flex-direction: column;
    }

    .company-actions {
      width: 100%;
    }

    .btn-edit, .btn-delete {
      flex: 1;
    }
  }
</style>

<div class="license-edit-container">
  <div class="license-edit-card">
    <div class="license-edit-header">
      <div class="license-edit-header-content">
        <h2>{% trans "Company License Management" %}</h2>
        <p>{% trans "Add, edit, and manage company licenses and expiration dates" %}</p>
      </div>
      <button type="button" class="btn-add-company" onclick="openAddCompanyModal()">
        <span>‚ûï</span>
        <span>{% trans "Add Company" %}</span>
      </button>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    {% if companies %}
      <div class="companies-list">
        {% for company in companies %}
          <div class="company-item">
            <div class="company-item-header">
              <h3 class="company-name">{{ company.company }}</h3>
              <div class="company-actions">
                <button type="button" class="btn-edit" 
                        data-company-id="{{ company.id }}" 
                        data-company-name="{{ company.company|escapejs }}" 
                        data-license-date="{% if company.license_expiry_date %}{{ company.license_expiry_date|date:"Y-m-d" }}{% endif %}">
                  {% trans "Edit" %}
                </button>
                <button type="button" class="btn-delete" 
                        data-company-id="{{ company.id }}" 
                        data-company-name="{{ company.company|escapejs }}">
                  {% trans "Delete" %}
                </button>
              </div>
            </div>
            <div class="company-details">
              <div class="company-detail-item">
                <span class="detail-label">{% trans "License Expiry Date" %}</span>
                {% if company.license_expiry_date %}
                  {% now "Y-m-d" as today %}
                  {% if company.license_expiry_date|date:'Y-m-d' < today %}
                    <span class="license-expiry expired">
                      {{ company.license_expiry_date|date:"d M Y" }} ({% trans "Expired" %})
                    </span>
                  {% else %}
                    {% with days_left=company.license_expiry_date|timeuntil %}
                      {% if days_left|slice:":1" == "0" or days_left|slice:":2"|make_list|first|add:"0" < "31" %}
                        <span class="license-expiry expiring-soon">
                          {{ company.license_expiry_date|date:"d M Y" }}
                        </span>
                      {% else %}
                        <span class="license-expiry valid">
                          {{ company.license_expiry_date|date:"d M Y" }}
                        </span>
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                {% else %}
                  <span class="license-expiry no-date">{% trans "Not Set" %}</span>
                {% endif %}
              </div>
              {% if company.address %}
                <div class="company-detail-item">
                  <span class="detail-label">{% trans "Address" %}</span>
                  <span class="detail-value">{{ company.address }}</span>
                </div>
              {% endif %}
              {% if company.city or company.state %}
                <div class="company-detail-item">
                  <span class="detail-label">{% trans "Location" %}</span>
                  <span class="detail-value">
                    {% if company.city %}{{ company.city }}{% endif %}{% if company.city and company.state %}, {% endif %}{% if company.state %}{{ company.state }}{% endif %}
                  </span>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">üè¢</div>
        <h3>{% trans "No companies yet" %}</h3>
        <p>{% trans "Start by adding your first company" %}</p>
        <button type="button" class="btn btn-primary" onclick="openAddCompanyModal()">
          {% trans "Add Your First Company" %}
        </button>
      </div>
    {% endif %}
  </div>
</div>

<!-- Add Company Modal -->
<div id="addCompanyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{% trans "Add New Company" %}</h3>
    </div>
    <form method="post" id="addCompanyForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_company">
      
      <div class="form-group">
        <label class="form-label" for="add_company_name">
          {% trans "Company Name" %}<span class="required">*</span>
        </label>
        <input 
          type="text" 
          name="company_name" 
          id="add_company_name" 
          class="form-input"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="add_address">
          {% trans "Address" %}
        </label>
        <textarea 
          name="address" 
          id="add_address" 
          class="form-textarea"
        ></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="add_country">
            {% trans "Country" %}
          </label>
          <input 
            type="text" 
            name="country" 
            id="add_country" 
            class="form-input"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="add_state">
            {% trans "State" %}
          </label>
          <input 
            type="text" 
            name="state" 
            id="add_state" 
            class="form-input"
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="add_city">
            {% trans "City" %}
          </label>
          <input 
            type="text" 
            name="city" 
            id="add_city" 
            class="form-input"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="add_zip">
            {% trans "ZIP Code" %}
          </label>
          <input 
            type="text" 
            name="zip" 
            id="add_zip" 
            class="form-input"
          />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="add_license_expiry_date">
          {% trans "License Expiry Date" %}
        </label>
        <input 
          type="date" 
          name="license_expiry_date" 
          id="add_license_expiry_date" 
          class="form-input"
        />
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeAddCompanyModal()">
          {% trans "Cancel" %}
        </button>
        <button type="submit" class="btn btn-primary">
          {% trans "Add Company" %}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Company Modal -->
<div id="editCompanyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{% trans "Edit Company" %}</h3>
    </div>
    <form method="post" id="editCompanyForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="edit_company">
      <input type="hidden" name="company_id" id="edit_company_id">
      
      <div class="form-group">
        <label class="form-label" for="edit_company_name">
          {% trans "Company Name" %}<span class="required">*</span>
        </label>
        <input 
          type="text" 
          name="company_name" 
          id="edit_company_name" 
          class="form-input"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="edit_license_expiry_date">
          {% trans "License Expiry Date" %}
        </label>
        <input 
          type="date" 
          name="license_expiry_date" 
          id="edit_license_expiry_date" 
          class="form-input"
        />
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeEditCompanyModal()">
          {% trans "Cancel" %}
        </button>
        <button type="submit" class="btn btn-primary">
          {% trans "Save Changes" %}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Form -->
<form method="post" id="deleteCompanyForm" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="action" value="delete_company">
  <input type="hidden" name="company_id" id="delete_company_id">
</form>

<script>
  function openAddCompanyModal() {
    document.getElementById('addCompanyModal').classList.add('active');
    document.getElementById('add_company_name').focus();
  }

  function closeAddCompanyModal() {
    document.getElementById('addCompanyModal').classList.remove('active');
    document.getElementById('addCompanyForm').reset();
  }

  function openEditCompanyModal(id, name, licenseDate) {
    document.getElementById('edit_company_id').value = id;
    document.getElementById('edit_company_name').value = name;
    document.getElementById('edit_license_expiry_date').value = licenseDate;
    document.getElementById('editCompanyModal').classList.add('active');
    document.getElementById('edit_company_name').focus();
  }

  function closeEditCompanyModal() {
    document.getElementById('editCompanyModal').classList.remove('active');
    document.getElementById('editCompanyForm').reset();
  }

  function confirmDeleteCompany(id, name) {
    if (confirm('{% trans "Are you sure you want to delete" %} "' + name + '"? {% trans "This action cannot be undone." %}')) {
      document.getElementById('delete_company_id').value = id;
      document.getElementById('deleteCompanyForm').submit();
    }
  }

  // Event delegation for edit and delete buttons
  document.addEventListener('DOMContentLoaded', function() {
    // Handle edit buttons
    document.querySelectorAll('.btn-edit').forEach(function(button) {
      button.addEventListener('click', function() {
        const id = this.getAttribute('data-company-id');
        const name = this.getAttribute('data-company-name');
        const licenseDate = this.getAttribute('data-license-date');
        openEditCompanyModal(id, name, licenseDate);
      });
    });

    // Handle delete buttons
    document.querySelectorAll('.btn-delete').forEach(function(button) {
      button.addEventListener('click', function() {
        const id = this.getAttribute('data-company-id');
        const name = this.getAttribute('data-company-name');
        confirmDeleteCompany(id, name);
      });
    });
  });

  // Close modals when clicking outside
  document.getElementById('addCompanyModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeAddCompanyModal();
    }
  });

  document.getElementById('editCompanyModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeEditCompanyModal();
    }
  });

  // Close modals with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeAddCompanyModal();
      closeEditCompanyModal();
    }
  });

  // Form validation
  document.getElementById('addCompanyForm').addEventListener('submit', function(e) {
    const nameInput = document.getElementById('add_company_name');
    if (!nameInput.value.trim()) {
      e.preventDefault();
      alert('{% trans "Please enter a company name" %}');
      nameInput.focus();
    }
  });

  document.getElementById('editCompanyForm').addEventListener('submit', function(e) {
    const nameInput = document.getElementById('edit_company_name');
    if (!nameInput.value.trim()) {
      e.preventDefault();
      alert('{% trans "Please enter a company name" %}');
      nameInput.focus();
    }
  });
</script>

{% endblock %}
